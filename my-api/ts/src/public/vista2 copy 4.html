<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtros Académicos</title>
    <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css" rel="stylesheet">
    <style>
        .filter-section {
            margin-bottom: 20px;
        }

        .filter-category ul {
            list-style-type: none;
            padding-left: 0;
        }

        .filter-category li {
            margin-bottom: 10px;
        }

        .filter-category {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- Encabezado -->
    <section class="hero is-danger">
        <div class="hero-body">
            <p class="title has-text-centered">
                Filtros Académicos
            </p>
        </div>
    </section>

    <!-- Contenedor Principal -->
    <div class="columns">
        <!-- Sidebar con filtros -->
        <aside class="column is-one-quarter">
            <div class="box">
                <h2 class="title is-5">Configuración Académica</h2>
                <p id="resultados" class="subtitle is-6">Resultados (0)</p>

                <!-- Barra de búsqueda -->
                <div class="field">
                    <div class="control">
                        <input class="input" type="text" placeholder="Buscar...">
                    </div>
                </div>

                <!-- Filtro Universidad -->
                <div class="filter-section">
                    <h3 class="title is-6">Universidad</h3>
                    <ul>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="universidad-checkbox"> Universidad
                            </label>
                        </li>
                    </ul>
                </div>

                <!-- Filtro Facultades -->
                <div id="facultades-filter" class="filter-section" style="display: none;">
                    <h3 class="title is-6">Facultades</h3>
                    <ul>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="facultad-checkbox-1"> Facultad de Ingeniería
                            </label>
                        </li>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="facultad-checkbox-2"> Facultad de Ciencias
                            </label>
                        </li>
                    </ul>
                </div>

                <!-- Filtro Especialidades -->
                <div id="especialidades-filter" class="filter-section" style="display: none;">
                    <h3 class="title is-6">Especialidades</h3>
                    <ul>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="especialidad-checkbox-1"> Ingeniería Informática
                            </label>
                        </li>
                        <li>
                            <label class="checkbox">
                                <input type="checkbox" id="especialidad-checkbox-2"> Biología
                            </label>
                        </li>
                    </ul>
                </div>

                <!-- Filtros adicionales -->
                <div class="filter-section">
                    <h3 class="title is-6">Periodo</h3>
                    <div class="field">
                        <div class="control">
                            <input class="input" type="text" placeholder="Ej: 20241">
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="title is-6">Fecha</h3>
                    <div class="field">
                        <div class="control">
                            <input class="input" type="date">
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            <input class="input" type="date">
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="title is-6">Medio</h3>
                    <div class="field">
                        <div class="control">
                            <div class="select">
                                <select>
                                    <option>Comunicación Interna</option>
                                    <option>Externa</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="title is-6">Responsable</h3>
                    <div class="field">
                        <div class="control">
                            <div class="select">
                                <select>
                                    <option>Departamento de Innovación</option>
                                    <option>Otros</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="title is-6">Procesa</h3>
                    <div class="field">
                        <div class="control">
                            <div class="select">
                                <select>
                                    <option>Equipo de Procesos</option>
                                    <option>Otro equipo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Contenido Principal con Tabla -->
        <section class="content">
            <div class="results-header">
                <select name="mes" id="mes-select">
                    <option value="tabla">Tabla</option>
                    <option value="calendario">Calendario</option>
                </select>
            </div>

            <!-- Tabla de resultados -->
            <div class="container" id="aqui_se_va_a_contruir_la_tabla"></div>

            <!-- Paginación -->
            <div class="pagination">
                <a href="#">&laquo;</a>
                <a href="#" class="active">1</a>
                <a href="#">2</a>
                <a href="#">3</a>
                <a href="#">4</a>
                <a href="#">&raquo;</a>
            </div>
        </section>
    </div>
</body>

<script>
    let data = [];
    let filters = {
        universidad: false,
        facultades: [],
        especialidades: [],
        periodo: '',
        fechaInicio: '',
        fechaFin: '',
        medio: '',
        responsable: '',
        procesa: ''
    };

    async function loadTable() {
        try {
            // Llamadas a las APIs para obtener las columnas y los datos
            const responseColumns = await fetch('http://localhost:3000/api/data/tablas');
            const columnsData = await responseColumns.json();
            const responseActivities = await fetch('http://localhost:3000/api/data/para-la-vita1');
            const activitiesData = await responseActivities.json();
            data = activitiesData; // Guardar los datos originales
            updateTable(columnsData[0], data);
            updateFilters(data);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function updateTable(columns, activities) {
        const container = document.getElementById('aqui_se_va_a_contruir_la_tabla');
        const filteredActivities = filterActivities(activities);

        // Actualizar el número de resultados
        document.getElementById('resultados').innerText = `Resultados (${filteredActivities.length})`;

        // Crear la tabla
        const table = document.createElement('table');
        table.classList.add('results-table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        Object.keys(columns).forEach(col => {
            if (col.startsWith('olumna')) {
                const th = document.createElement('th');
                th.textContent = columns[col];
                headerRow.appendChild(th);
            }
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        filteredActivities.forEach(activity => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${activity.periodo}</td>
                <td>${activity.codigo_actividad}</td>
                <td>${activity.fullcalendar.descripcion}</td>
                <td>${new Date(activity.fullcalendar.fecha_inicio).toLocaleDateString()}</td>
                <td>${new Date(activity.fullcalendar.fecha_fin).toLocaleDateString()}</td>
                <td>${activity.estado}</td>
                <td>${activity.jerarquia.nivel}</td>
                <td>${activity.medio.nombre}</td>
                <td>${activity.responsable.nombre}</td>
                <td>${activity.procesa.nombre}</td>
                <td>${activity.observacion}</td>
                <td><button>Opciones</button></td>
            `;
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        container.innerHTML = '';
        container.appendChild(table);
    }

    function updateFilters(activities) {
        // Mostrar las facultades y especialidades como listas
        const facultades = [...new Set(activities.map(a => a.facultad))];
        const especialidades = [...new Set(activities.map(a => a.especialidad))];

        const facultadesList = document.getElementById('facultades-list');
        facultadesList.innerHTML = facultades.map(f => `<li><label><input type="checkbox" value="${f}"> ${f}</label></li>`).join('');
        const especialidadesList = document.getElementById('especialidades-list');
        especialidadesList.innerHTML = especialidades.map(e => `<li><label><input type="checkbox" value="${e}"> ${e}</label></li>`).join('');

        // Mostrar filtros condicionalmente
        document.getElementById('universidad-checkbox').addEventListener('change', function () {
            const checked = this.checked;
            filters.universidad = checked;
            toggleFilterVisibility();
        });
    }

    function toggleFilterVisibility() {
        const facultadesFilter = document.getElementById('facultades-filter');
        const especialidadesFilter = document.getElementById('especialidades-filter');

        if (filters.universidad) {
            facultadesFilter.style.display = 'block';
            especialidadesFilter.style.display = 'block';
        } else {
            facultadesFilter.style.display = 'none';
            especialidadesFilter.style.display = 'none';
        }
    }

    function filterActivities(activities) {
        return activities.filter(a => {
            // Filtrar por universidad, facultad, especialidad, periodo, fecha, medio, responsable, procesa
            return (!filters.universidad || a.jerarquia.nivel === 'Universidad') &&
                (filters.facultades.length === 0 || filters.facultades.includes(a.facultad)) &&
                (filters.especialidades.length === 0 || filters.especialidades.includes(a.especialidad)) &&
                (!filters.periodo || a.periodo === filters.periodo) &&
                (!filters.fechaInicio || new Date(a.fullcalendar.fecha_inicio) >= new Date(filters.fechaInicio)) &&
                (!filters.fechaFin || new Date(a.fullcalendar.fecha_fin) <= new Date(filters.fechaFin)) &&
                (!filters.medio || a.medio.nombre === filters.medio) &&
                (!filters.responsable || a.responsable.nombre === filters.responsable) &&
                (!filters.procesa || a.procesa.nombre === filters.procesa);
        });
    }

    // Cargar la tabla al cargar la página
    window.onload = loadTable;
</script>

</html>